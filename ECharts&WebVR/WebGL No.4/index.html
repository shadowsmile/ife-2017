<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">	
	<title>WebGL No.4 - 照相机和交互控制</title>
	<style>
		body {
			margin: 0;
			overflow: hidden;
		}
		div {
			width: 100%;
			text-align: center;
			position: absolute;
			top: 20px;
		}
	</style>
</head>
<body onload="init()">
	<canvas id="mainCanvas"></canvas>
	<div>
		<span>
			Mouse Control： <br/>Left： Rotate， Middle： Zoom， Right： Pan
		</span>
	</div>

	<script type="text/javascript" src="../lib/three.js"></script>
	<script type="text/javascript" src="../lib/TrackballControls.js"></script>

	<script type="text/javascript">

		var renderer;
		var scene;
		var camera;
		var controls;

		init();
		animate();

		function init() {
			renderer = new THREE.WebGLRenderer({
				canvas: document.getElementById("mainCanvas"),
				antialias: true,  //清除锯齿
				precision: "highp"  //渲染精度
			});
			renderer.setSize(window.innerWidth, window.innerHeight);
			//renderer.setClearColor(0xf0f8ff);
			renderer.shadowMap.enabled = true;  //开启阴影
			//renderer.shadowMapSoft = true;  //软阴影？
			renderer.shadowMap.type = THREE.PCFSoftShadowMap;//软阴影

			scene = new THREE.Scene();
			scene.background = new THREE.Color( 0xaaaaaa );
			scene.fog = new THREE.FogExp2( 0xaaaaaa, 0.02 );

			camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 1, 1000);
			camera.position.z = 30;

			//controls
			controls = new THREE.TrackballControls(camera);
			controls.rotateSpeed = 1.0;
			controls.zoomSpeed = 1.2;
			controls.panSpeed = 0.8;

			controls.noZoom = false;  //开启鼠标滚轮缩放功能
			controls.noPan = false;  //开启鼠标右键平移功能

			controls.staticMoving = true;
			controls.dynamicDampingFactor = 0.3; //动态阻尼系数（灵敏度）

			//controls.keys = [65, 83, 68];  //按键ASD替代鼠标？

			controls.addEventListener('change', render);

			//雨滴
			var material = new THREE.MeshPhongMaterial({
				color: 0xbbffff,
				shininess: 100,  //数值越大，光斑越小，默认30
				//opacity: 0.9,  //透明度，与transparent配合使用
				//transparent: true  //开启透明度
			})

			for( var i = 0; i < 500; i ++) {
				//上部圆锥
				var cone = new THREE.Mesh(new THREE.ConeBufferGeometry(1, Math.sqrt(3), 64, true), material);
				cone.position.x = ( Math.random() - 0.5 ) * 100;
				cone.position.y = ( Math.random() - 0.5 ) * 100;
				cone.position.z = ( Math.random() - 0.5 ) * 100;
				scene.add(cone);

				//下部球体
				var ball = new THREE.Mesh(new THREE.SphereBufferGeometry(2/Math.sqrt(3), 64, 64, 0, Math.PI*2, Math.PI/3, Math.PI), material);
				ball.position.x = cone.position.x;
				ball.position.y = cone.position.y - 2.5 / Math.sqrt(3);
				ball.position.z = cone.position.z;
				scene.add(ball);
			}

			//平行光源
			var light = new THREE.DirectionalLight(0xffffff);
			light.position.set(-1, 1, 2);
			scene.add(light);

			//环境光
			var ambientLight = new THREE.AmbientLight(0x222222);
			scene.add(ambientLight);

			window.addEventListener( 'resize', onWindowResize, false );

			//渲染
			render();
		}

		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

			controls.handleResize();

			render();

		}

		function animate() {
			requestAnimationFrame(animate);
			controls.update();
		}

		function render() {
			renderer.render(scene, camera);
		}
	</script>
</body>
</html>